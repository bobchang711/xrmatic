<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script type="text/javascript" src="ClientGlobalContext.js.aspx"></script>
</head>
<body>
    <h1>Geocode Address Configuration Page</h1>

    <div id="IntegrationEnabled">Bing Maps Integration is </div>
    <div id="ApiKey">Bing Maps API Key: </div>

    <button type="button" id="StartButton">Start Geocoding</button>
    <ul id="AddressesUpdated"></ul>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script>
        $(document).ready(function () {
            $('button#StartButton').hide();

            CheckBingConfig();

            $('button#StartButton').click(function () {
                GetCRMAddresses();
            });
        });

        var ApiKey = ''; // Global variable

        function GetCRMAddresses() {
            var request = new XMLHttpRequest();
            // OData query
            var url = "/XRMServices/2011/OrganizationData.svc/CustomerAddressSet?" +
                "$select=City,CustomerAddressId,Line1,Line2,PostalCode,StateOrProvince&" +
                "$filter=(Latitude eq null and Longitude eq null) and " +
                    "(Line1 ne null and City ne null and StateOrProvince ne null) and " +
                    "not substringof('PO Box', Line1)&" +
                "$orderby=CreatedOn desc" +
                "&$top=5";

            // Synchronous request
            request.open("GET", encodeURI(Xrm.Page.context.getClientUrl() + url), false);
            request.setRequestHeader("Accept", "application/json");
            request.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            request.send();

            if (request.status === 200) { // OK
                var address;
                $.each(JSON.parse(request.responseText).d.results, function (i, result) {
                    address = '';
                    if (result.Line1 && result.Line1.length)
                        address = address + result.Line1 + ' ';
                    if (result.Line2 && result.Line2.length)
                        address = address + result.Line2 + ' ';
                    if (result.City && result.City.length)
                        address = address + result.City + ' ';
                    if (result.StateOrProvince && result.StateOrProvince.length)
                        address = address + result.StateOrProvince + ' ';
                    if (result.PostalCode && result.PostalCode.length)
                        address = address + result.PostalCode;

                    GeocodeAddress(address, result.CustomerAddressId);
                    $('ul#AddressesUpdated').append('<li id="' + result.CustomerAddressId + '">' + address + '</li>')
                });
            } else {
                alert(request.statusText);
            }
        }

        function GeocodeAddress(address, addressid) {
            if (address && address.length && ApiKey.length) {
                $('li#AddressesUpdated').html('');

                $.ajax({
                    url: "http://dev.virtualearth.net/REST/v1/Locations",
                    dataType: "jsonp",
                    data: {
                        key: ApiKey,
                        q: address
                    },
                    jsonp: "jsonp",
                    success: function (data) {
                        if (data.resourceSets && data.resourceSets.length) {
                            if (data.resourceSets[0].resources && data.resourceSets[0].resources.length) {
                                var latitude = data.resourceSets[0].resources[0].geocodePoints[0].coordinates[0];
                                var longitude = data.resourceSets[0].resources[0].geocodePoints[0].coordinates[1];

                                UpdateCRMAddress(addressid, latitude, longitude);
                                $('li#' + addressid).append(' : Found');
                            }
                        } else {
                            $('li#' + addressid).append(':n/a');
                        }
                    }
                });
            }
        }

        function UpdateCRMAddress(addressid, latitude, longitude) {
            var entity = {
                Latitude: latitude,
                Longitude: longitude
            };

            var request = new XMLHttpRequest();
            var url = "/XRMServices/2011/OrganizationData.svc/CustomerAddressSet(guid'" + addressid + "')";

            request.open("POST", encodeURI(Xrm.Page.context.getClientUrl() + url), true);
            request.setRequestHeader("Accept", "application/json");
            request.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            request.setRequestHeader("X-HTTP-Method", "MERGE");
            request.onreadystatechange = function () {
                if (this.readyState === 4) {
                    request.onreadystatechange = null;

                    if (this.status === 204 || this.status == 1223) { // No Content
                        $('li#' + addressid).append(' : Updated');
                    }
                }
            };
            request.send(JSON.stringify(entity));
        }

        function CheckBingConfig() {
            var request = new XMLHttpRequest();
            var url = "/XRMServices/2011/OrganizationData.svc/OrganizationSet?" +
                "$select=BingMapsApiKey,EnableBingMapsIntegration";

            // Synchronous request
            request.open("GET", encodeURI(Xrm.Page.context.getClientUrl() + url), false);
            request.setRequestHeader("Accept", "application/json");
            request.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            request.send(null);

            if (request.status === 200) { // OK
                $.each(JSON.parse(request.responseText).d.results, function (i, result) {
                    if (result.EnableBingMapsIntegration === true) {
                        $('div#IntegrationEnabled').append('Enabled');
                        $('div#ApiKey').append(result.BingMapsApiKey);
                        $('button#StartButton').show();
                        ApiKey = result.BingMapsApiKey;
                    } else {
                        $('div#IntegrationEnabled').append('Disabled');
                    }
                });
            } else {
                alert(request.statusText);
            }
        }
    </script>
</body>
</html>
